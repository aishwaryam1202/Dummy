@echo off
setlocal enabledelayedexpansion

REM === CONFIGURATION ===
set "ROOT_DIR=C:\path\to\start"

echo [START] Starting traversal at "%ROOT_DIR%"
echo.

call :traverse "%ROOT_DIR%"

echo.
echo [END] Finished traversal.
exit /b

REM === Traverse all folders recursively ===
:traverse
setlocal enabledelayedexpansion
set "CURRENT_DIR=%~1"
for %%I in ("%CURRENT_DIR%") do set "FOLDER_NAME=%%~nxI"

echo [TRACE] Entering folder "!CURRENT_DIR!" (Name: "!FOLDER_NAME!")

if /i "!FOLDER_NAME!"=="A" (
    echo [INFO] Found folder "A", processing Excel-only subfolders...
    endlocal
    call :process_excel_only_recursive "%CURRENT_DIR%" "A"
    exit /b
) else if /i "!FOLDER_NAME!"=="B" (
    echo [INFO] Found folder "B", processing Excel-only subfolders...
    endlocal
    call :process_excel_only_recursive "%CURRENT_DIR%" "B"
    exit /b
)

for /d %%D in ("%CURRENT_DIR%\*") do (
    call :traverse "%%D"
)

endlocal
exit /b

REM === Process Excel-only folders under A or B ===
:process_excel_only_recursive
setlocal enabledelayedexpansion
set "DIR=%~1"
set "PARENT_TYPE=%~2"

echo [RECURSIVE] Processing folder "%DIR%" (Parent: %PARENT_TYPE%)

for /d %%S in ("%DIR%\*") do (
    call :process_excel_only_recursive "%%S" "%PARENT_TYPE%"
)

call :folder_excel_only "%DIR%"
if errorlevel 1 (
    echo [SKIP] "%DIR%" is NOT Excel-only.
) else (
    echo [EXECUTE] "%DIR%" is Excel-only under "%PARENT_TYPE%". Renaming files...

    pushd "%DIR%"
    set /a counter=0
    for %%F in (*.xls *.xlsx *.xlsm) do (
        set /a counter+=1
        if !counter! EQU 1 (
            ren "%%F" "QWE.xlsx"
            echo [ACTION] Renamed "%%F" to "QWE.xlsx"
        ) else (
            ren "%%F" "QWE_!counter!.xlsx"
            echo [ACTION] Renamed "%%F" to "QWE_!counter!.xlsx"
        )
    )
    popd

    if /i "%PARENT_TYPE%"=="A" (
        echo [ACTION] Deleting folder "%DIR%" (under A)
        rd /s /q "%DIR%"
    ) else if /i "%PARENT_TYPE%"=="B" (
        set "DEST_FOLDER=%DIR%_copy"
        if exist "%DEST_FOLDER%" (
            echo [INFO] Removing existing copy "%DEST_FOLDER%"
            rd /s /q "%DEST_FOLDER%"
        )
        echo [ACTION] Copying "%DIR%" to "%DEST_FOLDER%"
        xcopy "%DIR%" "%DEST_FOLDER%" /e /i /q >nul
    )
)

endlocal
exit /b

REM === Check if folder contains only Excel files and no subfolders ===
:folder_excel_only
setlocal enabledelayedexpansion
set "CHECK_DIR=%~1"
set "HAS_SUBFOLDER=false"
set "HAS_OTHER_FILES=false"
set "HAS_EXCEL_FILES=false"

for /d %%D in ("%CHECK_DIR%\*") do (
    set "HAS_SUBFOLDER=true"
)

for %%F in ("%CHECK_DIR%\*") do (
    if exist "%%F" (
        set "EXT=%%~xF"
        if /i "!EXT!"==".xls"  (set "HAS_EXCEL_FILES=true") else (
        if /i "!EXT!"==".xlsx" (set "HAS_EXCEL_FILES=true") else (
        if /i "!EXT!"==".xlsm" (set "HAS_EXCEL_FILES=true") else (
            set "HAS_OTHER_FILES=true"
        )))
    )
)

if "!HAS_SUBFOLDER!"=="true" (
    echo [RESULT] Rejected: contains subfolders
    endlocal & exit /b 1
) else if "!HAS_OTHER_FILES!"=="true" (
    echo [RESULT] Rejected: contains non-Excel files
    endlocal & exit /b 1
) else if "!HAS_EXCEL_FILES!"=="true" (
    echo [RESULT] Accepted: only Excel files
    endlocal & exit /b 0
) else (
    echo [RESULT] Rejected: no files found
    endlocal & exit /b 1
)
